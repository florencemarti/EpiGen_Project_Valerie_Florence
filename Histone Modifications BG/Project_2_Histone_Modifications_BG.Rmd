---
title: "Project_2_Histone_Modifications_BG"
author: "Florence Marti"
date: "2025-06-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/GitHub/EpiGen_Project_Valerie_Florence/Histone Modifications BG")
```

```{r, include = FALSE}
suppressPackageStartupMessages({
  library(AnnotationHub)
  library(ensembldb)
  library(GenomicRanges)
  library(epiwraps)
  library(rtracklayer)
  library(ggplot2)
  library(magick)
  library(R.utils) 
  library(MASS)
  library(TxDb.Hsapiens.UCSC.hg38.knownGene)
  library(org.Hs.eg.db)
  library(AnnotationDbi)
})
```

# Importing the downloaded data
In this part I imported the peaks for the histone modifications H3K4me3, H3K4me1, and H3K27ac for monocytes (M0), macrophages (mf), and beta-glucan primed macrophages (BG). Additionally I imported the list of human TF's that play a role in macrophage polarisation.

```{r}
options(timeout = 12000)
# Monocytes
#H3K4me3
H3K4me3_M0 <- rtracklayer::import("H3K4me3_M0_BC17.bed", format = "BED")

#H3K27ac
H3K27ac_M0 <- rtracklayer::import("H3K27ac_M0_BC17.bed", format = "BED")

#H3K3me1
H3K4me1_M0 <- rtracklayer::import("H3K4me1_M0_BC17.bed", format = "BED")


# Macrophages
#H3K4me3
H3K4me3_MF <- rtracklayer::import("H3K4me3_MF_BC17.bed", format = "BED")

#H3K27ac
H3K27ac_MF <- rtracklayer::import("H3K27ac_MF_BC17.bed", format = "BED")

#H3K3me1
H3K4me1_MF <- rtracklayer::import("H3K4me1_MF_BC17.bed", format = "BED")


# BG primed
#H3K4me3
H3K4me3_BG <- rtracklayer::import("H3K4me3_BG_BC17.bed", format = "BED")

#H3K27ac
H3K27ac_BG <- rtracklayer::import("H3K27ac_BG_BC17.bed", format = "BED")

#H3K3me1
H3K4me1_BG <- rtracklayer::import("H3K4me1_BG_BC17.bed", format = "BED")

```

### Importing the pro- and anti-inflammatory transcription factors and creating a list out of them for further use.
Using rtracklayer and genomic ranges to find overlaps of transcription start sites with our histone modifications.
The input for the tss regions was generated using artificial intelligence.

```{r}
pro_inflammatory <- c("RELA", "RELB", "REL", "NFKB1", "NFKB2", "FOS", "JUN", "STAT1", "STAT2", 
                     "STAT3", "STAT4", "STAT5A", "STAT5B", "IRF5", "IRF8", "IRF1",
                     "IRF3", "CEBPA", "CEBPD", "SPI1", "KLF6", "HIF1A", "NOTCH1", "BRD4")

entrez_ids_pro <- mapIds(org.Hs.eg.db, keys = pro_inflammatory,
                        column = "ENTREZID", keytype = "SYMBOL", multiVals = "first")

entrez_ids_pro_df <- data.frame(HGNC_Symbol = names(entrez_ids_pro), 
                        Entrez_ID = as.character(entrez_ids_pro), 
                        stringsAsFactors = FALSE)

anti_inflammatory <- c("STAT6", "PPARG", "KLF4", "MAFB", "IRF4", "KDM6B", "MYC", "NR4A1", 
                      "BCL6", "CREB1", "RXRA", "FOXO1", "SP1", "GATA3", "SMAD3")

entrez_ids_anti <- mapIds(org.Hs.eg.db, keys = anti_inflammatory,
                         column = "ENTREZID", keytype = "SYMBOL", multiVals = "first")

entrez_ids_anti_df <- data.frame(HGNC_Symbol = names(entrez_ids_anti),
                            Entrez_ID = as.character(entrez_ids_anti),
                            stringsAsFactors = FALSE)

entrez_ids_pro_df
entrez_ids_anti_df


txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
genes_txdb <- genes(txdb)


# Extract Entrez IDs as character vector, removing NAs if needed
entrez_pro_ids <- as.character(entrez_ids_pro_df$Entrez_ID)
entrez_pro_ids <- entrez_pro_ids[!is.na(entrez_pro_ids)]

# Subset genes (GRanges) by matching names
selected_pro_genes <- genes_txdb[names(genes_txdb) %in% entrez_pro_ids]

# Get promoter regions for pro-inflammatory genes
tss_regions_pro <- promoters(selected_pro_genes, upstream = 2000, downstream = 2000)

# Repeat for anti-inflammatory genes
entrez_anti_ids <- as.character(entrez_ids_anti_df$Entrez_ID)
entrez_anti_ids <- entrez_anti_ids[!is.na(entrez_anti_ids)]

selected_anti_genes <- genes_txdb[names(genes_txdb) %in% entrez_anti_ids]

tss_regions_anti <- promoters(selected_anti_genes, upstream = 2000, downstream = 2000)
```

## me3 overlap
```{r}

me3_overlap_M0_pro <- countOverlaps(tss_regions_pro, H3K4me3_M0)
me3_overlap_M0_anti <- countOverlaps(tss_regions_anti, H3K4me3_M0)

me3_overlap_MF_pro <- countOverlaps(tss_regions_pro, H3K4me3_MF)
me3_overlap_MF_anti <- countOverlaps(tss_regions_anti, H3K4me3_MF)

me3_overlap_BG_pro <- countOverlaps(tss_regions_pro, H3K4me3_BG)
me3_overlap_BG_anti <- countOverlaps(tss_regions_anti, H3K4me3_BG)
```

## ac overlap
```{r}
ac_overlap_M0_pro <- countOverlaps(tss_regions_pro, H3K27ac_M0)
ac_overlap_M0_anti <- countOverlaps(tss_regions_anti, H3K27ac_M0)

ac_overlap_MF_pro <- countOverlaps(tss_regions_pro, H3K27ac_MF)
ac_overlap_MF_anti <- countOverlaps(tss_regions_anti, H3K27ac_MF)

ac_overlap_BG_pro <- countOverlaps(tss_regions_pro, H3K27ac_BG)
ac_overlap_BG_anti <- countOverlaps(tss_regions_anti, H3K27ac_BG)
```

## me1 overlap
```{r}
me1_overlap_M0_pro <- countOverlaps(tss_regions_pro, H3K4me1_M0)
me1_overlap_M0_anti <- countOverlaps(tss_regions_anti, H3K4me1_M0)

me1_overlap_MF_pro <- countOverlaps(tss_regions_pro, H3K4me1_MF)
me1_overlap_MF_anti <- countOverlaps(tss_regions_anti, H3K4me1_MF)

me1_overlap_BG_pro <- countOverlaps(tss_regions_pro, H3K4me1_BG)
me1_overlap_BG_anti <- countOverlaps(tss_regions_anti, H3K4me1_BG)
```

Using countOverlaps we find the regions (transcription start sites) that we pre determined as pro and anti inflammatory and we see how many of them overlap the peaks of our samples.

```{r}
dataframe_pro <- data.frame(TF= pro_inflammatory, 
                            M0_H3K4me3 = me3_overlap_M0_pro, M0_H3K27ac = ac_overlap_M0_pro , 
                            M0_H3K4me1 = me1_overlap_M0_pro , MF_H3K4me3 = me3_overlap_MF_pro, 
                            MF_H3K27ac = ac_overlap_MF_pro , MF_H3K4me1 = me1_overlap_MF_pro ,
                            BG_H3K4me3 = me3_overlap_BG_pro , BG_H3K27ac = ac_overlap_BG_pro, 
                            BG_H3K4me1 = me1_overlap_BG_pro)

dataframe_pro

dataframe_anti <- data.frame(TF= anti_inflammatory, 
                            M0_H3K4me3 = me3_overlap_M0_anti, M0_H3K27ac = ac_overlap_M0_anti , 
                            M0_H3K4me1 = me1_overlap_M0_anti , MF_H3K4me3 = me3_overlap_MF_anti, 
                            MF_H3K27ac = ac_overlap_MF_anti , MF_H3K4me1 = me1_overlap_MF_anti ,
                            BG_H3K4me3 = me3_overlap_BG_anti , BG_H3K27ac = ac_overlap_BG_anti, 
                            BG_H3K4me1 = me1_overlap_BG_anti)

dataframe_anti
```


Here in the dataframe we see for example NFKB1 overlaps 25 peaks of me3 in monocytes and in macrophages it overlaps 37, while in bg-primed cells it overlaps 57.

## Chromatin States

```{r}
assign_state <- function(me3, ac, me1) {
  if (me3 & ac & !me1) return("Active promoter")
  if (!me3 & ac & me1) return("Enhancer")
  if (me3 & !ac & !me1) return("Poised promoter")
  if (!me3 & ac & !me1) return("Unusual activation")
  if (!me3 & !ac & !me1) return("Unmarked")
  return("Other")
}

# Pro-inflammatory
dataframe_pro$ChromatinState_M0 <- mapply(assign_state,
                                          dataframe_pro$M0_H3K4me3,
                                          dataframe_pro$M0_H3K27ac,
                                          dataframe_pro$M0_H3K4me1)

dataframe_pro$ChromatinState_MF <- mapply(assign_state,
                                          dataframe_pro$MF_H3K4me3,
                                          dataframe_pro$MF_H3K27ac,
                                          dataframe_pro$MF_H3K4me1)

dataframe_pro$ChromatinState_BG <- mapply(assign_state,
                                          dataframe_pro$BG_H3K4me3,
                                          dataframe_pro$BG_H3K27ac,
                                          dataframe_pro$BG_H3K4me1)

# Anti-inflammatory
dataframe_anti$ChromatinState_M0 <- mapply(assign_state,
                                           dataframe_anti$M0_H3K4me3,
                                           dataframe_anti$M0_H3K27ac,
                                           dataframe_anti$M0_H3K4me1)

dataframe_anti$ChromatinState_MF <- mapply(assign_state,
                                           dataframe_anti$MF_H3K4me3,
                                           dataframe_anti$MF_H3K27ac,
                                           dataframe_anti$MF_H3K4me1)

dataframe_anti$ChromatinState_BG <- mapply(assign_state,
                                           dataframe_anti$BG_H3K4me3,
                                           dataframe_anti$BG_H3K27ac,
                                           dataframe_anti$BG_H3K4me1)
dataframe_pro
```

## Now looking at peaks that do not overlap with TSS regions

```{r}
tf_regions_pro <- promoters(genes(txdb)[entrez_ids_pro], upstream = 20000, downstream = 20000)
tf_regions_anti <- promoters(genes(txdb)[entrez_ids_anti], upstream = 20000, downstream = 20000)

# H3K4me3 - promoter-distal regions
distal_H3K4me3_M0 <- H3K4me3_M0[!H3K4me3_M0 %over% c(tss_regions_pro, tss_regions_anti)]
distal_H3K4me3_MF <- H3K4me3_MF[!H3K4me3_MF %over% c(tss_regions_pro, tss_regions_anti)]
distal_H3K4me3_BG <- H3K4me3_BG[!H3K4me3_BG %over% c(tss_regions_pro, tss_regions_anti)]

# H3K27ac - promoter-distal regions
distal_H3K27ac_M0 <- H3K27ac_M0[!H3K27ac_M0 %over% c(tss_regions_pro, tss_regions_anti)]
distal_H3K27ac_MF <- H3K27ac_MF[!H3K27ac_MF %over% c(tss_regions_pro, tss_regions_anti)]
distal_H3K27ac_BG <- H3K27ac_BG[!H3K27ac_BG %over% c(tss_regions_pro, tss_regions_anti)]

# H3K4me1 - promoter-distal regions
distal_H3K4me1_M0 <- H3K4me1_M0[!H3K4me1_M0 %over% c(tss_regions_pro, tss_regions_anti)]
distal_H3K4me1_MF <- H3K4me1_MF[!H3K4me1_MF %over% c(tss_regions_pro, tss_regions_anti)]
distal_H3K4me1_BG <- H3K4me1_BG[!H3K4me1_BG %over% c(tss_regions_pro, tss_regions_anti)]

```

```{r}
# Count overlaps for distal peaks - pro-inflammatory
me3_distal_M0_pro <- countOverlaps(tf_regions_pro, distal_H3K4me3_M0)
ac_distal_M0_pro  <- countOverlaps(tf_regions_pro, distal_H3K27ac_M0)
me1_distal_M0_pro <- countOverlaps(tf_regions_pro, distal_H3K4me1_M0)

me3_distal_MF_pro <- countOverlaps(tf_regions_pro, distal_H3K4me3_MF)
ac_distal_MF_pro  <- countOverlaps(tf_regions_pro, distal_H3K27ac_MF)
me1_distal_MF_pro <- countOverlaps(tf_regions_pro, distal_H3K4me1_MF)

me3_distal_BG_pro <- countOverlaps(tf_regions_pro, distal_H3K4me3_BG)
ac_distal_BG_pro  <- countOverlaps(tf_regions_pro, distal_H3K27ac_BG)
me1_distal_BG_pro <- countOverlaps(tf_regions_pro, distal_H3K4me1_BG)


# Count overlaps for distal peaks - anti-inflammatory
me3_distal_M0_anti <- countOverlaps(tf_regions_anti, distal_H3K4me3_M0)
ac_distal_M0_anti  <- countOverlaps(tf_regions_anti, distal_H3K27ac_M0)
me1_distal_M0_anti <- countOverlaps(tf_regions_anti, distal_H3K4me1_M0)

me3_distal_MF_anti <- countOverlaps(tf_regions_anti, distal_H3K4me3_MF)
ac_distal_MF_anti  <- countOverlaps(tf_regions_anti, distal_H3K27ac_MF)
me1_distal_MF_anti <- countOverlaps(tf_regions_anti, distal_H3K4me1_MF)

me3_distal_BG_anti <- countOverlaps(tf_regions_anti, distal_H3K4me3_BG)
ac_distal_BG_anti  <- countOverlaps(tf_regions_anti, distal_H3K27ac_BG)
me1_distal_BG_anti <- countOverlaps(tf_regions_anti, distal_H3K4me1_BG)

```
```{r}
# Pro-inflammatory distal dataframe
dataframe_pro_distal <- data.frame(
  TF = pro_inflammatory,
  M0_H3K4me3 = me3_distal_M0_pro, M0_H3K27ac = ac_distal_M0_pro, M0_H3K4me1 = me1_distal_M0_pro,
  MF_H3K4me3 = me3_distal_MF_pro, MF_H3K27ac = ac_distal_MF_pro, MF_H3K4me1 = me1_distal_MF_pro,
  BG_H3K4me3 = me3_distal_BG_pro, BG_H3K27ac = ac_distal_BG_pro, BG_H3K4me1 = me1_distal_BG_pro
)

# Anti-inflammatory distal dataframe
dataframe_anti_distal <- data.frame(
  TF = anti_inflammatory,
  M0_H3K4me3 = me3_distal_M0_anti, M0_H3K27ac = ac_distal_M0_anti, M0_H3K4me1 = me1_distal_M0_anti,
  MF_H3K4me3 = me3_distal_MF_anti, MF_H3K27ac = ac_distal_MF_anti, MF_H3K4me1 = me1_distal_MF_anti,
  BG_H3K4me3 = me3_distal_BG_anti, BG_H3K27ac = ac_distal_BG_anti, BG_H3K4me1 = me1_distal_BG_anti
)

```

```{r}
# Assign states for distal regions - pro
dataframe_pro_distal$ChromatinState_M0 <- mapply(assign_state,
                                                 dataframe_pro_distal$M0_H3K4me3,
                                                 dataframe_pro_distal$M0_H3K27ac,
                                                 dataframe_pro_distal$M0_H3K4me1)

dataframe_pro_distal$ChromatinState_MF <- mapply(assign_state,
                                                 dataframe_pro_distal$MF_H3K4me3,
                                                 dataframe_pro_distal$MF_H3K27ac,
                                                 dataframe_pro_distal$MF_H3K4me1)

dataframe_pro_distal$ChromatinState_BG <- mapply(assign_state,
                                                 dataframe_pro_distal$BG_H3K4me3,
                                                 dataframe_pro_distal$BG_H3K27ac,
                                                 dataframe_pro_distal$BG_H3K4me1)

# Assign states for distal regions - anti
dataframe_anti_distal$ChromatinState_M0 <- mapply(assign_state,
                                                  dataframe_anti_distal$M0_H3K4me3,
                                                  dataframe_anti_distal$M0_H3K27ac,
                                                  dataframe_anti_distal$M0_H3K4me1)

dataframe_anti_distal$ChromatinState_MF <- mapply(assign_state,
                                                  dataframe_anti_distal$MF_H3K4me3,
                                                  dataframe_anti_distal$MF_H3K27ac,
                                                  dataframe_anti_distal$MF_H3K4me1)

dataframe_anti_distal$ChromatinState_BG <- mapply(assign_state,
                                                  dataframe_anti_distal$BG_H3K4me3,
                                                  dataframe_anti_distal$BG_H3K27ac,
                                                  dataframe_anti_distal$BG_H3K4me1)

```

```{r}
dataframe_anti_distal
```

# Visualisation Attempt
```{r}
# Already centered ±10kb
tf_regions_20kb <- resize(tf_regions_pro, width = 40000, fix = "center")
tf_regions_20kb <- resize(tf_regions_anti, width = 40000, fix = "center")

```

```{r}
# List of conditions and modifications
conditions <- c("M0", "MF", "BG")
mods <- c("H3K4me3", "H3K27ac", "H3K4me1")

# Assume your peak data are named like H3K4me3_M0, H3K27ac_MF, etc.
# Your TF regions are in tf_regions_20kb

# Function to get object by name and create matrix
make_matrix <- function(mod, cond) {
  peak_obj_name <- paste0(mod, "_", cond)
  peaks <- get(peak_obj_name)  # gets the GRanges object from the variable name
  mat <- normalizeToMatrix(peaks, tf_regions_20kb,
                           value_column = "score", 
                           extend = 10000, w = 50, mean_mode = "w0", empty_value = 0)
  return(mat)
}

# Create a nested list of matrices: matrices[[condition]][[modification]]
matrices <- lapply(conditions, function(cond) {
  lapply(mods, function(mod) {
    make_matrix(mod, cond)
  })
})
names(matrices) <- conditions
for (cond in conditions) {
  names(matrices[[cond]]) <- mods
}





```

